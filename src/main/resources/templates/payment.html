<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
	<meta charset="utf-8" />
	<title>자동결제 등록</title>

	<!-- 토스페이먼츠 자동결제 SDK -->
	<script src="https://js.tosspayments.com/v1/payment"></script>
</head>
<body>

<h2>자동결제 등록</h2>

<!-- 자동결제 (빌링키 등록) 버튼 -->
<button class="button" id="billing-button" style="margin-top: 30px">자동결제 등록</button>

<!-- JavaScript에 서버에서 전달한 값들을 사용할 수 있도록 th:inline="javascript" 사용 -->
<script th:inline="javascript">
	/*<![CDATA[*/

	document.getElementById("billing-button").addEventListener("click", async function () {
		await createOrderAndRequestBillingAuth();
	});

	/**
	 * ✅ 1. 가주문 생성 후 자동결제(빌링키 등록) 실행
	 */
	async function createOrderAndRequestBillingAuth() {
		try {
			// ✅ 서버에 가주문 생성 요청
			const orderResponse = await fetch("/order", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({
					orderName: "자동결제 구독",
					amount: 5000  // 예제 금액
				})
			});

			const orderData = await orderResponse.json();
			const orderId = orderData.id;

			if (!orderId || orderId === "null") {
				alert("❌ 주문 생성 실패: orderId가 존재하지 않습니다.");
				return;
			}

			// ✅ 가주문 생성 완료 후, 빌링키 등록 실행
			requestBillingAuth(orderId);

		} catch (error) {
			console.error("❌ 주문 생성 중 오류 발생:", error);
			alert("가주문 생성 중 오류가 발생했습니다.");
		}
	}

	/**
	 * ✅ 2. 자동결제(빌링키 등록) 실행
	 */
	function requestBillingAuth(orderId) {
		var clientKey = "test_ck_d46qopOB89jXABDYMn9E3ZmM75y0";  // ✅ 클라이언트 키 설정
		var tossPayments = TossPayments(clientKey);

		tossPayments
				.requestBillingAuth("카드", {
					customerKey: "UPi_3XgExj7ZsRhUgpcyK", // ✅ 고객 고유 ID (빌링키와 연결됨)
					successUrl: window.location.origin + "/billing-success?orderId=" + orderId,
					failUrl: window.location.origin + "/billing-fail"
				})
				.catch(function (error) {
					if (error.code === "USER_CANCEL") {
						alert("❌ 사용자에 의해 결제가 취소되었습니다.");
					} else {
						alert("❌ 결제 실패: " + error.message);
					}
				});
	}
	/*]]>*/
</script>

</body>
</html>
